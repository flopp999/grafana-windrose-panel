{"version":3,"sources":["../src/wind_rose_ctrl.js"],"names":["template","angular","moment","_","TimeSeries","fileExport","MetricsPanelCtrl","WindRoseCtrl","$scope","$injector","$rootScope","annotationsSrv","panelDefaults","datasource","windRoseOptions","windRoseType","axisFrequency","axisName","scale","maxV","dotColors","val","lastPointColor","gradientBasedOn","alphaBlending","alphaBlendingMinOpacity","labelDegrees","labelCardinalCompass","labelIntercardinalCompass","labelCompassRose","labelCompassRoseOpacity","labelCompassRoseSize","numOfDirections","windSpeedStep","chartColors","showPercents","percentsPosition","chartOpacity","peakTypeBar","peakTypeLine","peakTypePoints","peakTypeLineFill","peakTypeLineWidth","peakTypePointsRadius","seriesOverrides","timeFrom","timeShift","targets","defaultsDeep","panel","copy","hiddenSeries","seriesList","colors","$root","customGradientFields","events","on","onRender","bind","onDataReceived","onDataError","onDataSnapshotLoad","onInitEditMode","onInitPanelActions","addEditorTab","subTabIndex","actions","push","text","click","axis","subItem","format","value","render","length","$q","when","map","target","delta","evt","publishAppEvent","snapshotData","data","err","dataList","datapointsWarning","datapointsCount","datapointsOutside","maxTimeSeries","msg","appEvent","slice","seriesHandler","self","each","item","alias","match","split","loading","seriesData","index","datapoints","colorIndex","color","series","unit","last","utc","from","range","filter","applySeriesOverrides","serie","event","ctrlKey","metaKey","shiftKey","toggleSeriesExclusiveMode","hidden","alreadyExclusive","every","override","without","exportSeriesListToCsv","exportSeriesListToCsvColumns"],"mappings":"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","file":"wind_rose_ctrl.js","sourcesContent":["import template from './template';\nimport angular from 'angular';\nimport moment from 'moment';\nimport _ from 'lodash';\nimport TimeSeries from 'app/core/time_series2';\nimport * as fileExport from 'app/core/utils/file_export';\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport './colorpicker';\nimport './css/style.css!';\nimport './css/colorpicker.css!';\n\nexport class WindRoseCtrl extends MetricsPanelCtrl {\n  /** @ngInject */\n  constructor($scope, $injector, $rootScope, annotationsSrv) {\n    super($scope, $injector, annotationsSrv);\n    this.$rootScope = $rootScope;\n\n    var panelDefaults = {\n      // datasource name, null = default datasource\n      datasource: null,\n      // windrose options\n      windRoseOptions: {\n        windRoseType: '1',\n        axisFrequency: '15',\n        axisName: 'Windspeed, m/s',\n        scale: 'linear',\n        maxV: '',\n        dotColors: [{val: '#000000'}],\n        lastPointColor: '#000000',\n        gradientBasedOn: 'age',\n        alphaBlending: true,\n        alphaBlendingMinOpacity: 0,\n        labelDegrees: true,\n        labelCardinalCompass: false,\n        labelIntercardinalCompass: false,\n        labelCompassRose: false,\n        labelCompassRoseOpacity: 0.4,\n        labelCompassRoseSize: 0.8,\n        numOfDirections: '4',\n        windSpeedStep: 0.5,\n        chartColors: [{val: '#0000ff'}],\n        showPercents: true,\n        percentsPosition: 45,\n        chartOpacity: 1,\n        peakTypeBar: false,\n        peakTypeLine: true,\n        peakTypePoints: false,\n        peakTypeLineFill: '0',\n        peakTypeLineWidth: '1',\n        peakTypePointsRadius: '4'\n      },\n      seriesOverrides: [],\n      // time overrides\n      timeFrom: null,\n      timeShift: null,\n      // metric queries\n      targets: [{}]\n    };\n\n    _.defaultsDeep(this.panel, angular.copy(panelDefaults));\n\n    this.hiddenSeries = {};\n    this.seriesList = [];\n    this.colors = $scope.$root.colors;\n\n    this.customGradientFields = [];\n\n    this.events.on('render', this.onRender.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-error', this.onDataError.bind(this));\n    this.events.on('data-snapshot-load', this.onDataSnapshotLoad.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('init-panel-actions', this.onInitPanelActions.bind(this));\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Axes', 'public/plugins/n-wind-rose-panel/tab_axes.html', 3);\n    this.addEditorTab('Options', 'public/plugins/n-wind-rose-panel/tab_options.html', 4);\n\n    this.subTabIndex = 0;\n  }\n\n  onInitPanelActions(actions) {\n    actions.push({text: 'Export CSV (series as rows)', click: 'ctrl.exportCsv()'});\n    actions.push({text: 'Export CSV (series as columns)', click: 'ctrl.exportCsvColumns()'});\n  }\n\n  setUnitFormat(axis, subItem) {\n    axis.format = subItem.value;\n    this.render();\n  }\n\n  issueQueries(datasource) {\n    if (!this.panel.targets || this.panel.targets.length === 0) {\n      return this.$q.when([]);\n    }\n\n    this.panel.targets = _.map(this.panel.targets, function (target) {\n      target.delta = true; // notify delta support\n      return target;\n    });\n\n    return super.issueQueries(datasource);\n  }\n\n  zoomOut(evt) {\n    this.publishAppEvent('zoom-out', evt);\n  }\n\n  onDataSnapshotLoad(snapshotData) {\n    this.onDataReceived(snapshotData.data);\n  }\n\n  onDataError(err) {\n    this.seriesList = [];\n    this.render([]);\n  }\n\n  onDataReceived(dataList) {\n    this.datapointsWarning = false;\n    this.datapointsCount = 0;\n    this.datapointsOutside = false;\n    var maxTimeSeries = 56;\n    if (dataList.length > maxTimeSeries) {\n      var msg = 'wind rose panel warning: exceed max time series (support' + maxTimeSeries + ' time series)';\n      this.$rootScope.appEvent('alert-warning', [msg, '']);\n      dataList = dataList.slice(0, maxTimeSeries); // TODO: support only 5 time series\n    }\n    this.seriesList = dataList.map(this.seriesHandler.bind(this));\n    this.customGradientFields = [];\n    var self = this;\n    this.seriesList = _.each(this.seriesList, function (item) {\n        var alias = item['alias'].match(/\\[(.*)\\]/);\n        if (alias && alias[1] && alias[1] != 'direction') {\n            self.customGradientFields.push(item['alias'].split('[')[0]);\n        }\n    });\n    this.datapointsWarning = this.datapointsCount === 0 || this.datapointsOutside;\n\n    this.loading = false;\n    this.render(this.seriesList);\n  }\n\n  seriesHandler(seriesData, index) {\n    var datapoints = seriesData.datapoints;\n    var alias = seriesData.target;\n    var colorIndex = index % this.colors.length;\n    var color = this.colors[colorIndex];\n\n    var series = new TimeSeries({\n      datapoints: datapoints,\n      alias: alias,\n      color: color,\n      unit: seriesData.delta || false // TODO: fix, use unit as delta temporaly\n    });\n\n    if (datapoints && datapoints.length > 0) {\n      var last = moment.utc(datapoints[datapoints.length - 1][1]);\n      var from = moment.utc(this.range.from);\n      if (last - from < -10000) {\n        this.datapointsOutside = true;\n      }\n\n      this.datapointsCount += datapoints.length;\n    }\n\n    return series;\n  }\n\n  onRender() {\n    if (!this.seriesList) { return; }\n    var self = this;\n    this.seriesList = _.filter(this.seriesList, function (item) {\n        var alias = item['alias'].match(/\\[(.*)\\]/);\n        return alias && alias[1] && (alias[1] === 'speed_min' || alias[1] === 'speed_max' || alias[1] === 'speed_avg');\n    });\n    _.each(this.seriesList, function (item) {\n        item.applySeriesOverrides(self.panel.seriesOverrides);\n    });\n  }\n\n  toggleSeries(serie, event) {\n    if (event.ctrlKey || event.metaKey || event.shiftKey) {\n      if (this.hiddenSeries[serie.alias]) {\n        delete this.hiddenSeries[serie.alias];\n      } else {\n        this.hiddenSeries[serie.alias] = true;\n      }\n    } else {\n      this.toggleSeriesExclusiveMode(serie);\n    }\n    this.render();\n  }\n\n  toggleSeriesExclusiveMode (serie) {\n    var hidden = this.hiddenSeries;\n\n    if (hidden[serie.alias]) {\n      delete hidden[serie.alias];\n    }\n\n    // check if every other series is hidden\n    var alreadyExclusive = _.every(this.seriesList, value => {\n      if (value.alias === serie.alias) {\n        return true;\n      }\n\n      return hidden[value.alias];\n    });\n\n    if (alreadyExclusive) {\n      // remove all hidden series\n      _.each(this.seriesList, value => {\n        delete this.hiddenSeries[value.alias];\n      });\n    } else {\n      // hide all but this serie\n      _.each(this.seriesList, value => {\n        if (value.alias === serie.alias) {\n          return;\n        }\n\n        this.hiddenSeries[value.alias] = true;\n      });\n    }\n  }\n\n  addSeriesOverride(override) {\n    this.panel.seriesOverrides.push(override || {});\n  }\n\n  removeSeriesOverride(override) {\n    this.panel.seriesOverrides = _.without(this.panel.seriesOverrides, override);\n    this.render();\n  }\n\n  exportCsv() {\n    fileExport.exportSeriesListToCsv(this.seriesList);\n  }\n\n  exportCsvColumns() {\n    fileExport.exportSeriesListToCsvColumns(this.seriesList);\n  }\n}\n\nWindRoseCtrl.template = template;\n"]}